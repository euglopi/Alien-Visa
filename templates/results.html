{% extends "base.html" %}

{% block title %}Results - O-1 Visa Readiness Analyzer{% endblock %}

{% block content %}
<div class="min-h-screen py-12 px-4">
    <div class="max-w-3xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">O-1A Assessment Criteria</h1>
            <p class="text-gray-600">Based on your uploaded resume</p>
        </div>

        <div id="summary-card" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Summary</h2>
                <span id="tier-badge" class="px-4 py-1 rounded-full text-sm font-bold
                    {% if tier == 'Strong' %}bg-green-100 text-green-800 border border-green-300{% elif tier == 'Moderate' %}bg-yellow-100 text-yellow-800 border border-yellow-300{% else %}bg-red-100 text-red-800 border border-red-300{% endif %}">
                    {% if tier == "Strong" %}Strong Case{% elif tier == "Moderate" %}Moderate Case{% else %}Needs Work{% endif %}
                </span>
            </div>

            <div class="mb-4">
                <div class="flex justify-between text-sm text-gray-600 mb-1">
                    <span>Criteria Met</span>
                    <span id="criteria-count" class="font-medium">{{ criteria_met }}/8</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progress-bar" class="h-3 rounded-full transition-all
                        {% if tier == 'Strong' %}bg-green-500{% elif tier == 'Moderate' %}bg-yellow-500{% else %}bg-red-500{% endif %}"
                        style="width: {{ (criteria_met / 8) * 100 }}%"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-400 mt-1">
                    <span>0</span>
                    <span class="text-gray-500">3 required</span>
                    <span>8</span>
                </div>
            </div>

            <p class="text-gray-600">
                You need to meet at least 3 of the 8 criteria to qualify for an O-1A visa.
                <span id="tier-message" class="font-medium
                    {% if tier == 'Strong' %}text-green-600{% elif tier == 'Moderate' %}text-yellow-600{% else %}text-red-600{% endif %}">
                    {% if tier == "Strong" %}You exceed the minimum threshold with a strong case.
                    {% elif tier == "Moderate" %}You meet the minimum threshold. Consider strengthening additional criteria.
                    {% else %}You may need to strengthen your profile to meet the minimum threshold.{% endif %}
                </span>
            </p>
        </div>

        <!-- Mentor Connect: inline mentor search based on your field -->
        <div id="mentor-connect-card" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-start justify-between gap-4">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Get mentor feedback on this assessment</h2>
                    <p class="text-sm text-gray-600 mt-1">
                        Share your resume and these AI results with successful O-1 holders and ask for human feedback.
                    </p>
                </div>
                <span class="hidden sm:inline-flex items-center rounded-full bg-blue-50 px-3 py-1 text-xs font-medium text-blue-700">
                    Mentor Connect
                </span>
            </div>

            <div class="mt-4 grid gap-3 sm:grid-cols-3">
                <div>
                    <label for="mentor-field" class="block text-xs font-medium text-gray-700 mb-1">Field *</label>
                    <select id="mentor-field" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select a field...</option>
                        <option value="Computer Science">Computer Science</option>
                        <option value="Medicine">Medicine</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Arts">Arts</option>
                        <option value="Business">Business</option>
                        <option value="Education">Education</option>
                        <option value="Athletics">Athletics</option>
                        <option value="Film/TV">Film/TV</option>
                        <option value="Science">Science</option>
                    </select>
                </div>
                <div>
                    <label for="mentor-subfield" class="block text-xs font-medium text-gray-700 mb-1">Subfield (optional)</label>
                    <input
                        id="mentor-subfield"
                        type="text"
                        placeholder="e.g., AI/ML, Cardiology"
                        class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-end">
                    <button
                        type="button"
                        onclick="findMentorsForResults()"
                        class="w-full inline-flex items-center justify-center rounded-md bg-blue-600 text-white px-4 py-2 text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Find mentors for resume review
                    </button>
                </div>
            </div>

            <div id="mentor-connect-loading" class="mt-4 hidden text-sm text-gray-500">
                Finding mentors who match your field...
            </div>

            <div id="mentor-connect-results" class="mt-4 space-y-3"></div>
        </div>

        <div id="criteria-list" class="space-y-4">
            {% for criterion in criteria %}
            <div class="bg-white rounded-lg shadow-md p-6" data-criterion="{{ criterion.name }}">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0 mt-1">
                        <span class="criterion-icon inline-flex items-center justify-center w-6 h-6 rounded-full {% if criterion.met %}bg-green-100{% else %}bg-red-100{% endif %}">
                            {% if criterion.met %}
                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            {% else %}
                            <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            {% endif %}
                        </span>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900 criterion-name">{{ criterion.name }}</h3>
                        <p class="text-sm text-gray-500 mb-2 criterion-description">{{ criterion.description }}</p>
                        <div class="evidence-container {% if not criterion.evidence %}hidden{% endif %}">
                            <div class="mt-2 p-3 bg-gray-50 rounded-md">
                                <p class="text-sm text-gray-700">
                                    <span class="font-medium">Evidence:</span> <span class="criterion-evidence">{{ criterion.evidence }}</span>
                                </p>
                            </div>
                        </div>
                        <p class="mt-2 text-sm text-gray-500 italic criterion-reasoning {% if not criterion.reasoning %}hidden{% endif %}">{{ criterion.reasoning }}</p>

                        <button
                            onclick="openChallengePanel('{{ criterion.name }}')"
                            class="mt-3 inline-flex items-center gap-1.5 text-sm text-blue-600 hover:text-blue-800 font-medium transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            Challenge this assessment
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% if parsed_resume %}
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <details>
                <summary class="cursor-pointer font-semibold text-gray-800 hover:text-gray-600">
                    View Parsed Resume Text
                    {% if not parsed_resume.parse_success %}
                    <span class="ml-2 text-red-600 text-sm">(Parse Error)</span>
                    {% endif %}
                </summary>
                <div class="mt-4">
                    {% if parsed_resume.parse_success %}
                    <div class="text-xs text-gray-500 mb-2">
                        File: {{ parsed_resume.filename }} ({{ parsed_resume.file_type | upper }})
                    </div>
                    <pre class="bg-gray-50 p-4 rounded-md text-sm text-gray-700 whitespace-pre-wrap overflow-x-auto max-h-96 overflow-y-auto">{{ parsed_resume.raw_text }}</pre>
                    {% else %}
                    <div class="bg-red-50 p-4 rounded-md">
                        <p class="text-red-700">
                            <span class="font-medium">Error parsing resume:</span>
                            {{ parsed_resume.error_message }}
                        </p>
                    </div>
                    {% endif %}
                </div>
            </details>
        </div>
        {% endif %}

        <div class="mt-8 flex flex-col sm:flex-row items-center justify-between gap-4">
            <a href="/" class="text-blue-600 hover:text-blue-800 font-medium">
                &larr; Analyze another resume
            </a>
            <div class="flex flex-col sm:flex-row gap-3">
                <a
                    href="/mentors"
                    class="inline-flex items-center justify-center rounded-md bg-blue-600 text-white px-4 py-2 text-sm font-medium hover:bg-blue-700 transition-colors"
                >
                    Consult a mentor about these results
                </a>
                <a
                    href="/experts"
                    class="inline-flex items-center justify-center rounded-md border border-gray-300 text-gray-700 px-4 py-2 text-sm font-medium hover:bg-gray-50 transition-colors"
                >
                    Talk to an expert letter writer
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Challenge Sidebar Overlay -->
<div id="challenge-overlay"
     class="fixed inset-0 bg-black/50 hidden z-40 transition-opacity"
     onclick="closeChallengePanel()"></div>

<!-- Challenge Sidebar Panel -->
<div id="challenge-panel"
     class="fixed top-0 right-0 h-full w-full md:w-[450px] bg-white shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 flex flex-col">

    <!-- Header -->
    <div class="p-4 border-b flex justify-between items-center bg-gray-50">
        <div>
            <h2 id="challenge-title" class="font-semibold text-lg text-gray-900">Challenge: Awards</h2>
            <p class="text-sm text-gray-500">Explore evidence for this criterion</p>
        </div>
        <button onclick="closeChallengePanel()" class="text-gray-400 hover:text-gray-600 p-1">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <!-- Chat Messages -->
    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
        <!-- Messages will be rendered here -->
    </div>

    <!-- Loading indicator -->
    <div id="chat-loading" class="hidden px-4 py-2">
        <div class="flex items-center gap-2 text-gray-500">
            <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-sm">Thinking...</span>
        </div>
    </div>

    <!-- Suggestion Chips -->
    <div id="suggestion-chips" class="hidden px-4 py-2">
        <div class="flex flex-wrap gap-2"></div>
    </div>

    <!-- Input Area -->
    <div class="p-4 border-t bg-gray-50">
        <!-- Voice/Text Toggle -->
        <div class="flex gap-2 mb-3">
            <button
                id="text-mode-btn"
                onclick="setInputMode('text')"
                class="flex-1 py-2 px-3 rounded-lg text-sm font-medium bg-blue-100 text-blue-700 border-2 border-blue-500">
                Text
            </button>
            <button
                id="voice-mode-btn"
                onclick="setInputMode('voice')"
                class="flex-1 py-2 px-3 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 border-2 border-transparent hover:border-purple-300">
                Voice
            </button>
        </div>

        <!-- Text Input Mode -->
        <div id="text-input-area" class="flex gap-2">
            <input
                type="text"
                id="chat-input"
                class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="Type your response..."
                onkeypress="handleChatKeypress(event)">
            <button
                id="send-btn"
                onclick="sendMessage()"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                Send
            </button>
        </div>

        <!-- Voice Input Mode -->
        <div id="voice-input-area" class="hidden">
            <div class="flex flex-col items-center gap-3">
                <!-- Speed Slider -->
                <div class="w-full flex items-center gap-2 px-2">
                    <span class="text-xs text-gray-500">Speed:</span>
                    <input
                        type="range"
                        id="voice-speed-slider"
                        min="0.8"
                        max="1.5"
                        step="0.1"
                        value="1.2"
                        class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600"
                        onchange="updateVoiceSpeed(this.value)"
                        oninput="document.getElementById('speed-value').textContent = this.value + 'x'">
                    <span id="speed-value" class="text-xs text-gray-600 w-8">1.2x</span>
                </div>

                <!-- Voice Status -->
                <div id="voice-status" class="text-sm text-gray-500">
                    Click microphone to start
                </div>

                <!-- Microphone Button -->
                <button
                    id="mic-btn"
                    onclick="toggleVoice()"
                    class="w-16 h-16 rounded-full bg-purple-600 text-white flex items-center justify-center hover:bg-purple-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg id="mic-icon" class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                    </svg>
                    <svg id="mic-active-icon" class="w-8 h-8 hidden animate-pulse" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"></path>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"></path>
                    </svg>
                </button>

                <!-- Audio Visualizer -->
                <div id="audio-visualizer" class="hidden flex items-center gap-1 h-8">
                    <div class="w-1 bg-purple-500 rounded-full animate-pulse" style="height: 30%"></div>
                    <div class="w-1 bg-purple-500 rounded-full animate-pulse" style="height: 60%; animation-delay: 0.1s"></div>
                    <div class="w-1 bg-purple-500 rounded-full animate-pulse" style="height: 100%; animation-delay: 0.2s"></div>
                    <div class="w-1 bg-purple-500 rounded-full animate-pulse" style="height: 60%; animation-delay: 0.3s"></div>
                    <div class="w-1 bg-purple-500 rounded-full animate-pulse" style="height: 30%; animation-delay: 0.4s"></div>
                </div>

                <!-- Connection status -->
                <div id="voice-connection" class="hidden text-xs text-gray-400">
                    <span id="connection-dot" class="inline-block w-2 h-2 rounded-full bg-green-500 mr-1"></span>
                    Connected
                </div>
            </div>
        </div>

        <button
            id="rescore-btn"
            onclick="requestRescore()"
            class="mt-3 w-full border-2 border-green-600 text-green-600 px-4 py-2 rounded-lg hover:bg-green-50 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed">
            Request Rescore
        </button>
    </div>
</div>

<script>
// State
const sessionId = "{{ session_id }}";
let currentCriterion = null;
let messageCount = 0;
let suggestionsVisible = false;

// Open challenge panel
async function openChallengePanel(criterionName) {
    currentCriterion = criterionName;
    messageCount = 0;

    document.getElementById('challenge-title').textContent = `Challenge: ${criterionName}`;
    document.getElementById('chat-messages').innerHTML = '';
    document.getElementById('rescore-btn').disabled = false;
    document.getElementById('rescore-btn').textContent = 'Request Rescore';
    document.getElementById('rescore-btn').classList.remove('border-gray-400', 'text-gray-400');
    document.getElementById('rescore-btn').classList.add('border-green-600', 'text-green-600', 'hover:bg-green-50');
    document.getElementById('chat-input').value = '';
    hideSuggestions();

    // Show panel with animation
    document.getElementById('challenge-overlay').classList.remove('hidden');
    document.getElementById('challenge-panel').classList.remove('translate-x-full');
    document.body.style.overflow = 'hidden';

    // Show loading
    setLoading(true);

    try {
        const response = await fetch(`/challenge/${sessionId}/${encodeURIComponent(criterionName)}/start`, {
            method: 'POST'
        });

        if (!response.ok) throw new Error('Failed to start challenge');

        const data = await response.json();
        renderMessages(data.messages);
        if (data.suggestions && data.suggestions.length > 0) {
            renderSuggestions(data.suggestions);
        }
    } catch (error) {
        addMessageToChat('assistant', 'Sorry, there was an error starting the challenge. Please try again.');
        console.error('Error:', error);
    } finally {
        setLoading(false);
        document.getElementById('chat-input').focus();
    }
}

// Close challenge panel
function closeChallengePanel() {
    document.getElementById('challenge-overlay').classList.add('hidden');
    document.getElementById('challenge-panel').classList.add('translate-x-full');
    document.body.style.overflow = '';
}

// Render suggestion chips
function renderSuggestions(suggestions) {
    const container = document.getElementById('suggestion-chips');
    const chipsDiv = container.querySelector('div');
    chipsDiv.innerHTML = '';

    suggestions.forEach(text => {
        const chip = document.createElement('button');
        chip.className = 'px-3 py-1.5 text-sm bg-blue-50 text-blue-700 rounded-full hover:bg-blue-100 transition-colors border border-blue-200';
        chip.textContent = text;
        chip.onclick = () => useSuggestion(text);
        chipsDiv.appendChild(chip);
    });

    container.classList.remove('hidden');
    suggestionsVisible = true;
}

// Use a suggestion (sends it as a message)
function useSuggestion(text) {
    document.getElementById('chat-input').value = text;
    sendMessage();
}

// Hide suggestions
function hideSuggestions() {
    document.getElementById('suggestion-chips').classList.add('hidden');
    suggestionsVisible = false;
}

// Handle Enter key in chat input
function handleChatKeypress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

// Send user message
async function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message) return;

    hideSuggestions();
    input.value = '';
    setInputDisabled(true);

    // Add user message immediately
    addMessageToChat('user', message);
    messageCount++;

    setLoading(true);

    try {
        const response = await fetch(`/challenge/${sessionId}/${encodeURIComponent(currentCriterion)}/chat`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ message })
        });

        if (!response.ok) throw new Error('Failed to send message');

        const data = await response.json();
        addMessageToChat('assistant', data.assistant_message);
        messageCount++;
        if (data.suggestions && data.suggestions.length > 0) {
            renderSuggestions(data.suggestions);
        }
    } catch (error) {
        addMessageToChat('assistant', 'Sorry, there was an error processing your message. Please try again.');
        console.error('Error:', error);
    } finally {
        setLoading(false);
        setInputDisabled(false);
        input.focus();
    }
}

// Request rescore
async function requestRescore() {
    const rescoreBtn = document.getElementById('rescore-btn');
    rescoreBtn.disabled = true;
    rescoreBtn.textContent = 'Rescoring...';

    try {
        const response = await fetch(`/challenge/${sessionId}/${encodeURIComponent(currentCriterion)}/rescore`, {
            method: 'POST'
        });

        if (!response.ok) throw new Error('Failed to rescore');

        const data = await response.json();

        if (data.success) {
            // Update the score summary first (most important)
            updateScoreSummary(data.new_score, data.new_tier);

            // Update the criterion card on the page
            updateCriterionCard(currentCriterion, data.criterion);
            markAsChallenged(currentCriterion);

            // Show success message in chat
            const statusText = data.criterion.met ? 'MET' : 'NOT MET';
            addMessageToChat('assistant', `Assessment updated! This criterion is now marked as **${statusText}**.\n\n**Updated reasoning:** ${data.criterion.reasoning}`);

            rescoreBtn.textContent = 'Rescore Complete';
            rescoreBtn.classList.remove('border-green-600', 'text-green-600', 'hover:bg-green-50');
            rescoreBtn.classList.add('border-gray-400', 'text-gray-400');
        }
    } catch (error) {
        addMessageToChat('assistant', 'Sorry, there was an error rescoring. Please try again.');
        rescoreBtn.disabled = false;
        rescoreBtn.textContent = 'Request Rescore';
        console.error('Error:', error);
    }
}

// Render all messages
function renderMessages(messages) {
    const container = document.getElementById('chat-messages');
    container.innerHTML = '';
    messages.forEach(msg => addMessageToChat(msg.role, msg.content));
}

// Add a single message to chat
function addMessageToChat(role, content) {
    const container = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

    const bubble = document.createElement('div');
    bubble.className = role === 'user'
        ? 'max-w-[85%] bg-blue-600 text-white rounded-2xl rounded-br-md px-4 py-2'
        : 'max-w-[85%] bg-gray-100 text-gray-800 rounded-2xl rounded-bl-md px-4 py-2';

    // Simple markdown-like formatting
    let formatted = content
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');

    bubble.innerHTML = `<p class="text-sm whitespace-pre-wrap">${formatted}</p>`;
    messageDiv.appendChild(bubble);
    container.appendChild(messageDiv);

    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

// Update criterion card after rescore
function updateCriterionCard(criterionName, newData) {
    const card = document.querySelector(`[data-criterion="${criterionName}"]`);
    if (!card) return;

    const iconContainer = card.querySelector('.criterion-icon');
    const evidenceContainer = card.querySelector('.evidence-container');
    const evidenceSpan = card.querySelector('.criterion-evidence');
    const reasoningP = card.querySelector('.criterion-reasoning');

    // Update icon
    if (iconContainer) {
        if (newData.met) {
            iconContainer.className = 'criterion-icon inline-flex items-center justify-center w-6 h-6 rounded-full bg-green-100';
            iconContainer.innerHTML = `<svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>`;
        } else {
            iconContainer.className = 'criterion-icon inline-flex items-center justify-center w-6 h-6 rounded-full bg-red-100';
            iconContainer.innerHTML = `<svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>`;
        }
    }

    // Update evidence
    if (evidenceContainer && evidenceSpan) {
        if (newData.evidence) {
            evidenceContainer.classList.remove('hidden');
            evidenceSpan.textContent = newData.evidence;
        } else {
            evidenceContainer.classList.add('hidden');
        }
    }

    // Update reasoning
    if (reasoningP) {
        if (newData.reasoning) {
            reasoningP.classList.remove('hidden');
            reasoningP.textContent = newData.reasoning;
        } else {
            reasoningP.classList.add('hidden');
        }
    }
}

// Mark criterion as successfully challenged
function markAsChallenged(criterionName) {
    const card = document.querySelector(`[data-criterion="${criterionName}"]`);
    if (!card || card.querySelector('.challenged-badge')) return;

    const badge = document.createElement('span');
    badge.className = 'challenged-badge inline-flex items-center gap-1 text-xs text-green-700 bg-green-50 px-2 py-1 rounded-full mt-2';
    badge.innerHTML = `
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        Successfully challenged
    `;

    const contentDiv = card.querySelector('.flex-1');
    const challengeBtn = contentDiv.querySelector('button');
    contentDiv.insertBefore(badge, challengeBtn);
}

// Update score summary after rescore
function updateScoreSummary(newScore, newTier) {
    // Update count
    document.getElementById('criteria-count').textContent = `${newScore}/8`;

    // Update progress bar
    const progressBar = document.getElementById('progress-bar');
    progressBar.style.width = `${(newScore / 8) * 100}%`;
    progressBar.className = 'h-3 rounded-full transition-all ' +
        (newTier === 'Strong' ? 'bg-green-500' : newTier === 'Moderate' ? 'bg-yellow-500' : 'bg-red-500');

    // Update tier badge
    const tierBadge = document.getElementById('tier-badge');
    if (newTier === 'Strong') {
        tierBadge.className = 'px-4 py-1 rounded-full text-sm font-bold bg-green-100 text-green-800 border border-green-300';
        tierBadge.textContent = 'Strong Case';
    } else if (newTier === 'Moderate') {
        tierBadge.className = 'px-4 py-1 rounded-full text-sm font-bold bg-yellow-100 text-yellow-800 border border-yellow-300';
        tierBadge.textContent = 'Moderate Case';
    } else {
        tierBadge.className = 'px-4 py-1 rounded-full text-sm font-bold bg-red-100 text-red-800 border border-red-300';
        tierBadge.textContent = 'Needs Work';
    }

    // Update tier message
    const tierMessage = document.getElementById('tier-message');
    if (newTier === 'Strong') {
        tierMessage.className = 'font-medium text-green-600';
        tierMessage.textContent = 'You exceed the minimum threshold with a strong case.';
    } else if (newTier === 'Moderate') {
        tierMessage.className = 'font-medium text-yellow-600';
        tierMessage.textContent = 'You meet the minimum threshold. Consider strengthening additional criteria.';
    } else {
        tierMessage.className = 'font-medium text-red-600';
        tierMessage.textContent = 'You may need to strengthen your profile to meet the minimum threshold.';
    }
}

// Helper functions
function setLoading(loading) {
    document.getElementById('chat-loading').classList.toggle('hidden', !loading);
}

function setInputDisabled(disabled) {
    document.getElementById('chat-input').disabled = disabled;
    document.getElementById('send-btn').disabled = disabled;
}

// Mentor Connect: inline mentor search + request
async function findMentorsForResults() {
    const fieldSelect = document.getElementById('mentor-field');
    const subfieldInput = document.getElementById('mentor-subfield');
    const loadingEl = document.getElementById('mentor-connect-loading');
    const resultsEl = document.getElementById('mentor-connect-results');

    if (!fieldSelect || !resultsEl || !loadingEl) return;

    const field = fieldSelect.value;
    const subfield = subfieldInput.value;

    if (!field) {
        alert('Please select a field');
        return;
    }

    loadingEl.classList.remove('hidden');
    resultsEl.innerHTML = '';

    try {
        const response = await fetch(`/api/mentors?field=${encodeURIComponent(field)}&subfield=${encodeURIComponent(subfield)}&limit=3`);
        if (!response.ok) throw new Error('Failed to load mentors');
        const data = await response.json();
        renderMentorsForResults(data.mentors || []);
    } catch (error) {
        console.error('Error finding mentors:', error);
        resultsEl.innerHTML = '<p class="text-sm text-red-600">Could not load mentors. Please try again.</p>';
    } finally {
        loadingEl.classList.add('hidden');
    }
}

function renderMentorsForResults(mentors) {
    const resultsEl = document.getElementById('mentor-connect-results');
    if (!resultsEl) return;

    if (!mentors || mentors.length === 0) {
        resultsEl.innerHTML = '<p class="text-sm text-gray-600">No mentors found yet for this field. Try another field or check back later.</p>';
        return;
    }

    resultsEl.innerHTML = '';

    mentors.forEach((mentor) => {
        const card = document.createElement('div');
        card.className = 'border border-gray-200 rounded-lg p-3 flex items-center justify-between';

        const info = document.createElement('div');
        const nameEl = document.createElement('p');
        nameEl.className = 'text-sm font-medium text-gray-900';
        nameEl.textContent = mentor.name;

        const fieldEl = document.createElement('p');
        fieldEl.className = 'text-xs text-gray-500';
        fieldEl.textContent = mentor.field + (mentor.subfield ? ' • ' + mentor.subfield : '');

        const qualsEl = document.createElement('p');
        qualsEl.className = 'text-xs text-gray-500 mt-1';
        if (mentor.key_qualifications && mentor.key_qualifications.length) {
            qualsEl.textContent = mentor.key_qualifications.slice(0, 2).join(' • ');
        }

        info.appendChild(nameEl);
        info.appendChild(fieldEl);
        if (qualsEl.textContent) {
            info.appendChild(qualsEl);
        }

        const button = document.createElement('button');
        button.className = 'ml-3 inline-flex items-center rounded-md bg-blue-600 text-white px-3 py-1.5 text-xs font-medium hover:bg-blue-700';
        button.textContent = 'Request review';
        button.addEventListener('click', () => requestMentorReview(mentor));

        card.appendChild(info);
        card.appendChild(button);
        resultsEl.appendChild(card);
    });
}

async function requestMentorReview(mentor) {
    if (!sessionId) {
        alert('Session expired. Please upload your resume again to request a mentor review.');
        return;
    }

    const defaultMessage = 'I would love your feedback on my resume and this O-1 assessment. Where am I strongest and what should I work on next?';
    const message = prompt(`What would you like ${mentor.name} to focus on?`, defaultMessage);
    if (message === null) return;

    try {
        const response = await fetch('/api/mentorship-requests', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mentor_id: mentor.id,
                session_id: sessionId,
                field: mentor.field,
                message,
            }),
        });

        if (!response.ok) throw new Error('Request failed');

        alert('Your request was logged. A coordinator or future matching flow can use this to connect you with this mentor.');
    } catch (error) {
        console.error('Error creating mentorship request:', error);
        alert('Could not send the request. Please try again.');
    }
}

// Close panel on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeChallengePanel();
});

// ==================== VOICE FUNCTIONALITY ====================

let inputMode = 'text';
let voiceSocket = null;
let audioContext = null;
let mediaStream = null;
let audioWorklet = null;
let isVoiceActive = false;
let audioQueue = [];
let isPlaying = false;
let currentAudioSource = null;  // Track current playing audio for interruption

// Set input mode (text or voice)
function setInputMode(mode) {
    inputMode = mode;

    const textBtn = document.getElementById('text-mode-btn');
    const voiceBtn = document.getElementById('voice-mode-btn');
    const textArea = document.getElementById('text-input-area');
    const voiceArea = document.getElementById('voice-input-area');

    if (mode === 'text') {
        textBtn.className = 'flex-1 py-2 px-3 rounded-lg text-sm font-medium bg-blue-100 text-blue-700 border-2 border-blue-500';
        voiceBtn.className = 'flex-1 py-2 px-3 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 border-2 border-transparent hover:border-purple-300';
        textArea.classList.remove('hidden');
        voiceArea.classList.add('hidden');
        // Disconnect voice if switching away
        if (voiceSocket) {
            disconnectVoice();
        }
    } else {
        textBtn.className = 'flex-1 py-2 px-3 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 border-2 border-transparent hover:border-blue-300';
        voiceBtn.className = 'flex-1 py-2 px-3 rounded-lg text-sm font-medium bg-purple-100 text-purple-700 border-2 border-purple-500';
        textArea.classList.add('hidden');
        voiceArea.classList.remove('hidden');
        // Automatically start voice connection when switching to voice mode
        if (!isVoiceActive) {
            connectVoice();
        }
    }
}

// Toggle voice connection
async function toggleVoice() {
    if (isVoiceActive) {
        disconnectVoice();
    } else {
        await connectVoice();
    }
}

// Connect to voice WebSocket
async function connectVoice() {
    if (!currentCriterion) return;

    const micBtn = document.getElementById('mic-btn');
    const voiceStatus = document.getElementById('voice-status');
    micBtn.disabled = true;
    voiceStatus.textContent = 'Connecting...';

    try {
        // Request microphone access
        mediaStream = await navigator.mediaDevices.getUserMedia({
            audio: {
                sampleRate: 24000,
                channelCount: 1,
                echoCancellation: true,
                noiseSuppression: true,
            }
        });

        // Create audio context
        audioContext = new (window.AudioContext || window.webkitAudioContext)({
            sampleRate: 24000
        });

        // Connect WebSocket
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/voice/${sessionId}/${encodeURIComponent(currentCriterion)}`;
        voiceSocket = new WebSocket(wsUrl);

        voiceSocket.onopen = () => {
            console.log('Voice WebSocket connected');
        };

        voiceSocket.onmessage = async (event) => {
            const data = JSON.parse(event.data);
            handleVoiceMessage(data);
        };

        voiceSocket.onerror = (error) => {
            console.error('Voice WebSocket error:', error);
            voiceStatus.textContent = 'Connection error';
            disconnectVoice();
        };

        voiceSocket.onclose = () => {
            console.log('Voice WebSocket closed');
            if (isVoiceActive) {
                disconnectVoice();
            }
        };

        // Wait for session ready
        await waitForSessionReady();

        // Send current speed setting
        const currentSpeed = document.getElementById('voice-speed-slider').value;
        updateVoiceSpeed(currentSpeed);

        // Start audio capture
        await startAudioCapture();

        isVoiceActive = true;
        updateVoiceUI(true);

    } catch (error) {
        console.error('Failed to connect voice:', error);
        voiceStatus.textContent = error.message || 'Failed to connect';
        micBtn.disabled = false;
        disconnectVoice();
    }
}

// Wait for session ready message
function waitForSessionReady() {
    return new Promise((resolve, reject) => {
        const timeout = setTimeout(() => reject(new Error('Connection timeout')), 10000);

        const originalHandler = voiceSocket.onmessage;
        voiceSocket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'session.ready' || data.type === 'session.updated') {
                clearTimeout(timeout);
                voiceSocket.onmessage = originalHandler;
                resolve();
            } else if (data.type === 'error') {
                clearTimeout(timeout);
                reject(new Error(data.message));
            }
            // Still handle other messages
            if (originalHandler) originalHandler(event);
        };
    });
}

// Start capturing audio from microphone
async function startAudioCapture() {
    const source = audioContext.createMediaStreamSource(mediaStream);

    // Create a script processor for audio capture (fallback for browsers without AudioWorklet)
    const bufferSize = 4096;
    const processor = audioContext.createScriptProcessor(bufferSize, 1, 1);

    processor.onaudioprocess = (event) => {
        if (!isVoiceActive || !voiceSocket || voiceSocket.readyState !== WebSocket.OPEN) return;

        const inputData = event.inputBuffer.getChannelData(0);

        // Convert float32 to int16 PCM
        const pcm16 = new Int16Array(inputData.length);
        for (let i = 0; i < inputData.length; i++) {
            const s = Math.max(-1, Math.min(1, inputData[i]));
            pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
        }

        // Convert to base64
        const base64 = btoa(String.fromCharCode(...new Uint8Array(pcm16.buffer)));

        // Send to server
        voiceSocket.send(JSON.stringify({
            type: 'audio',
            audio: base64
        }));
    };

    source.connect(processor);
    processor.connect(audioContext.destination);

    audioWorklet = processor;
}

// Handle incoming voice messages
function handleVoiceMessage(data) {
    const voiceStatus = document.getElementById('voice-status');

    switch (data.type) {
        case 'session.created':
        case 'session.updated':
            voiceStatus.textContent = 'Ready - speak now';
            break;

        case 'speech.started':
            voiceStatus.textContent = 'Listening...';
            document.getElementById('audio-visualizer').classList.remove('hidden');
            // Barge-in: Stop AI audio when user starts speaking
            interruptAIPlayback();
            break;

        case 'speech.stopped':
            voiceStatus.textContent = 'Processing...';
            document.getElementById('audio-visualizer').classList.add('hidden');
            break;

        case 'audio.delta':
            // Queue audio for playback
            if (data.audio) {
                audioQueue.push(data.audio);
                playNextAudio();
            }
            voiceStatus.textContent = 'Assistant speaking...';
            break;

        case 'audio.done':
            voiceStatus.textContent = 'Your turn - speak now';
            break;

        case 'transcript.done':
            // Add transcript to chat
            addMessageToChat(data.role, data.transcript);
            messageCount++;
            if (messageCount >= 2) {
                document.getElementById('rescore-btn').classList.remove('hidden');
            }
            break;

        case 'response.done':
            voiceStatus.textContent = 'Your turn - speak now';
            break;

        case 'error':
            voiceStatus.textContent = `Error: ${data.message}`;
            console.error('Voice error:', data.message);
            break;
    }
}

// Interrupt AI audio playback (barge-in)
function interruptAIPlayback() {
    // Stop current audio source
    if (currentAudioSource) {
        try {
            currentAudioSource.stop();
        } catch (e) {
            // Already stopped
        }
        currentAudioSource = null;
    }

    // Clear pending audio queue
    audioQueue = [];
    isPlaying = false;

    // Send cancel event to OpenAI to stop generating more audio
    if (voiceSocket && voiceSocket.readyState === WebSocket.OPEN) {
        voiceSocket.send(JSON.stringify({ type: 'response.cancel' }));
    }

    console.log('AI playback interrupted (barge-in)');
}

// Play audio from queue
async function playNextAudio() {
    if (isPlaying || audioQueue.length === 0 || !audioContext) return;

    isPlaying = true;

    while (audioQueue.length > 0) {
        const base64Audio = audioQueue.shift();

        try {
            // Decode base64 to PCM16
            const binaryString = atob(base64Audio);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            // Convert PCM16 to Float32
            const pcm16 = new Int16Array(bytes.buffer);
            const float32 = new Float32Array(pcm16.length);
            for (let i = 0; i < pcm16.length; i++) {
                float32[i] = pcm16[i] / 32768.0;
            }

            // Create audio buffer and play
            const audioBuffer = audioContext.createBuffer(1, float32.length, 24000);
            audioBuffer.getChannelData(0).set(float32);

            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            currentAudioSource = source;  // Track for interruption

            await new Promise((resolve) => {
                source.onended = () => {
                    if (currentAudioSource === source) {
                        currentAudioSource = null;
                    }
                    resolve();
                };
                source.start();
            });
        } catch (error) {
            console.error('Audio playback error:', error);
        }
    }

    isPlaying = false;
}

// Disconnect voice
function disconnectVoice() {
    isVoiceActive = false;

    if (voiceSocket) {
        voiceSocket.close();
        voiceSocket = null;
    }

    if (audioWorklet) {
        audioWorklet.disconnect();
        audioWorklet = null;
    }

    if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
    }

    if (audioContext) {
        audioContext.close();
        audioContext = null;
    }

    audioQueue = [];
    isPlaying = false;

    updateVoiceUI(false);
}

// Update voice speed
function updateVoiceSpeed(speed) {
    if (voiceSocket && voiceSocket.readyState === WebSocket.OPEN) {
        voiceSocket.send(JSON.stringify({
            type: 'session.update',
            session: { speed: parseFloat(speed) }
        }));
    }
}

// Update voice UI
function updateVoiceUI(active) {
    const micBtn = document.getElementById('mic-btn');
    const micIcon = document.getElementById('mic-icon');
    const micActiveIcon = document.getElementById('mic-active-icon');
    const voiceStatus = document.getElementById('voice-status');
    const voiceConnection = document.getElementById('voice-connection');
    const visualizer = document.getElementById('audio-visualizer');

    micBtn.disabled = false;

    if (active) {
        micBtn.className = 'w-16 h-16 rounded-full bg-red-600 text-white flex items-center justify-center hover:bg-red-700 transition-all';
        micIcon.classList.add('hidden');
        micActiveIcon.classList.remove('hidden');
        voiceStatus.textContent = 'Connecting to AI...';
        voiceConnection.classList.remove('hidden');
    } else {
        micBtn.className = 'w-16 h-16 rounded-full bg-purple-600 text-white flex items-center justify-center hover:bg-purple-700 transition-all';
        micIcon.classList.remove('hidden');
        micActiveIcon.classList.add('hidden');
        voiceStatus.textContent = 'Click microphone to start';
        voiceConnection.classList.add('hidden');
        visualizer.classList.add('hidden');
    }
}

// Clean up voice when panel closes
const originalCloseChallengePanel = closeChallengePanel;
closeChallengePanel = function() {
    disconnectVoice();
    setInputMode('text');
    originalCloseChallengePanel();
};
</script>
{% endblock %}
